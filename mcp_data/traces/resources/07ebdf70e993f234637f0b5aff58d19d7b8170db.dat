!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var n=t();for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(this,(()=>(()=>{"use strict";var e,t,n,i,r,s,a={d:(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},o={};a.r(o),a.d(o,{ActivityChange:()=>c,ActivityType:()=>e,AgentChannelDestination:()=>l,AssignmentType:()=>i,AsyncResponseType:()=>r,AttachmentErrorType:()=>E,AvailabilityType:()=>n,Channel:()=>G,ChannelClose:()=>d,ChannelContextItem:()=>Y,ChannelContextNameType:()=>x,ChannelDestination:()=>K,ChannelDestinationType:()=>t,ChannelStateType:()=>N,ConnectionStateType:()=>v,DisconnectType:()=>V,ErrorReason:()=>k,FeedbackActions:()=>j,FeedbackItems:()=>$,FileDetails:()=>P,HumanResource:()=>Q,LeadChange:()=>q,MemberDisconnect:()=>p,MemberUpdate:()=>D,MercuryErrorType:()=>W,MercuryEventType:()=>O,MercuryOffer:()=>ee,Message:()=>S,MessageFailed:()=>te,MessageType:()=>z,OfferResponseType:()=>J,OfferStatus:()=>U,OfferStatusTypes:()=>w,Participant:()=>R,ParticipantAdded:()=>C,ParticipationRoleType:()=>A,QueueChannelDestination:()=>L,Resource:()=>T,ResourceType:()=>s,RoleChange:()=>M,Session:()=>fe,UploadCompleted:()=>F,UploadStatusType:()=>b,WorkOfferBehaviorType:()=>X,convertLocalContextToContactInfo:()=>I});class c{constructor(){this.created=new Date}}!function(e){e.LISTENING="LISTENING",e.RESPONDING="RESPONDING",e.AGENTS_ONLY_RESPONDING="AGENTS_ONLY_RESPONDING"}(e||(e={})),function(e){e.RESOURCE="RESOURCE",e.QUEUE="QUEUE"}(t||(t={})),function(e){e.PRESENT="PRESENT",e.Available="Available",e.Uavailable="Unavailable",e.AVAILABLE="Available",e.UNAVAILABLE="Unavailable"}(n||(n={}));class l{constructor(e){this._engageRef=e,this.destinationType=t.RESOURCE}get name(){return this._engageRef.getName()}get identifier(){return this._engageRef.id}get currentChannelCount(){return this._engageRef.getCurrentSessionCount()}get availableCapacity(){return this._engageRef.getAvailableCapacity()}get status(){switch(this._engageRef.getStatus()){case"AVAILABLE":case"Available":return n.AVAILABLE;default:return n.UNAVAILABLE}}get accountId(){return this._engageRef.getAccountId()}}!function(e){e.LEAD="LEAD",e.TRANSFER="TRANSFER",e.CONFERENCE="CONFERENCE",e.MONITOR="MONITOR"}(i||(i={})),function(e){e.COMPLETE="COMPLETE",e.PROCESSING="PROCESSING",e.UNAVAILABLE="UNAVAILABLE"}(r||(r={}));class E{}class d{constructor(){this.created=new Date}}!function(e){e.HUMAN="HUMAN",e.BOT="BOT",e.END_USER="END_USER",e.AGENT="AGENT",e.SUPERVISOR="SUPERVISOR",e.Agent="AGENT",e.Supervisor="SUPERVISOR"}(s||(s={}));const f=[],h=(e,t)=>{f.forEach((n=>{"function"==typeof n.error?n.error(e,t):n.log(e,t)}))},u=(e,t)=>{f.forEach((n=>{"function"==typeof n.warn?n.warn(e,t):n.log(e,t)}))},g=(e,t)=>{f.forEach((n=>{"function"==typeof n.info?n.info(e,t):n.log(e,t)}))},_=(e,t,...n)=>{f.forEach((i=>{"function"==typeof i.event?i.event(e,t,...n):i.log(t,`firing ${e} with ${JSON.stringify(n)}`)}))};class T{static onSetterInvoked(e,t,n){this._settlerWarningShown||null!=t&&(this._settlerWarningShown=!0,u(`EngageAdapter:Resource:${e}:`,"Using setters on Engage-managed objects is deprecated. Implement a derived class if you need to emulate such object for transcript or logging."))}constructor(e,t,n){if(this._identifier="",this._name="",e){switch(this._identifier=e.getIdentifier(),e.getRole()){case"visitor":this._type=s.END_USER;break;case"agent":case"coach":case"monitor":case"conferee":default:this._type=s.AGENT;break;case"supervisor":this._type=s.SUPERVISOR}!0===t||"function"!=typeof e?this._type!==s.AGENT&&this._type!==s.SUPERVISOR||(this._type=s.HUMAN):this._type!==s.AGENT&&this._type!==s.SUPERVISOR||(e.isBot()?this._type=s.BOT:this._type=s.HUMAN),"string"==typeof n&&(this._name=n)}}updateRole(e){T.onSetterInvoked("role",void 0,e)}cacheContextProperty(e,t){}setContextProperty(e,t){return Promise.resolve()}get identifier(){return this._identifier}set identifier(e){T.onSetterInvoked("identifier",this._identifier,e),this._identifier=e}get type(){return this._type}set type(e){T.onSetterInvoked("type",this._type,e),this._type=e}get name(){return this._name}set name(e){T.onSetterInvoked("name",this.name,e),this._name=e}isBot(){return this._type===s.BOT}getConnectionState(){return"DISCONNECTED"}getName(){return this.name}getGreeting(){return""}getEmailAddress(){return""}getIdentifier(){return this.identifier}getRole(){switch(this._type){case s.SUPERVISOR:case s.AGENT:case s.BOT:return"agent";case s.END_USER:return"visitor";default:return"unknown"}}getContext(){return{}}static revive(e){const t=new T;return t._identifier=e.identifier,t._name=e.name,t._type=e.type,t}toJSON(){return{identifier:this.identifier,name:this.name,type:this.type}}}var A;T._settlerWarningShown=!1,function(e){e.UNKNOWN="UNKNOWN",e.END_USER="END_USER",e.TRANSIENT="TRANSIENT",e.ENDUSER="END_USER",e.LEAD="LEAD",e.CONFEREE="CONFEREE",e.MONITOR="MONITOR",e.COACH="COACH"}(A||(A={}));const I=e=>(null==e&&(e={}),void 0!==e.customFields||(e.customFields=[]),e);class R{static onSetterInvoked(e,t,n){this._settlerWarningShown||null!=t&&(this._settlerWarningShown=!0,u(`EngageAdapter:Participant:${e}:`,"Using setters on Engage-managed objects is deprecated. Implement a derived class if you need to emulate such object for transcript or logging."))}constructor(e,t,n=!1){if(this._isLocal=!1,this._transferCompleted=!1,this._ref=e,this._engagement=null!=t?t:null,n&&!t)throw new Error("Engagement reference required");this._isLocal=n,this._resource=new T(e,n,this.name),this.setTransferCompleted=this.setTransferCompleted.bind(this)}setTransferCompleted(e){this._transferCompleted=e}reference(){return this._ref}get resource(){return this._resource}get isConnected(){return this._isLocal?this._ref.isConnected():"function"!=typeof this._ref.getConnectionState||"ACTIVE"===this._ref.getConnectionState()}get identifier(){var e;return(null===(e=this._ref)||void 0===e?void 0:e.getIdentifier())||null}set identifer(e){R.onSetterInvoked("identifer",this.identifer,e)}get name(){var e,t,n,i;const r="(Unknown name)";if(this._isLocal||"function"!=typeof this._ref.getName){const i=this._ref.getContext();return i&&(`${null!==(e=i.firstName)&&void 0!==e?e:""} ${null!==(t=i.lastName)&&void 0!==t?t:""}`.trim()||`${null!==(n=i.displayName)&&void 0!==n?n:""}`.trim())||r}return null!==(i=this._ref.getName())&&void 0!==i?i:r}set name(e){R.onSetterInvoked("name",this.name,e)}get role(){switch(this._isLocal?this._engagement.getLocalParticipantRole():this._ref.getRole()){case"visitor":return A.END_USER;case"agent":return A.LEAD;case"conferee":return this._transferCompleted?A.LEAD:A.CONFEREE;case"coach":return A.COACH;case"monitor":return A.MONITOR;default:return A.UNKNOWN}}getContext(){return I(this._ref.getContext())}getRole(){return this._ref.getRole()}set role(e){R.onSetterInvoked("role",this.role,e)}static convert(e){return e}static revive(e){return e}toJSON(){let e;return this.resource&&(e=this.resource),{identifier:this.identifier,isConnected:this.isConnected,name:this.name,resource:e,role:this.role}}}R._settlerWarningShown=!1;class S{constructor(e,t){this._sender=null,this._engagementId=null,this._attachment=!1,this._messageDataMap=new Map,e?(this._ref=e,e.messageDataMap&&Object.keys(e.messageDataMap).forEach((t=>{this._messageDataMap.set(t,e.messageDataMap[t])}))):this._ref={created:new Date,body:""},this._ref.visibility||(this._ref.visibility=[]),t&&(this._engagementId=t)}isSender(e){var t;return(null===(t=this.sender)||void 0===t?void 0:t.identifier)===e.identifier}get sender(){return null===this._sender&&null!==this._ref.sender&&void 0!==this._ref.sender&&(this._sender=new R(this._ref.sender,null)),this._sender}set sender(e){this._sender=e}get richText(){var e;return null!==(e=this._ref.richText)&&void 0!==e&&e}set richText(e){this._ref.richText=e}set isAgentsOnly(e){this._ref.isAgentsOnly=e}get isAgentsOnly(){var e;return null!==(e=this._ref.isAgentsOnly)&&void 0!==e&&e}get offTheRecord(){var e;return null!==(e=this._ref.offTheRecord)&&void 0!==e&&e}get body(){return this._ref.body}set body(e){this._ref.body=e}get type(){return this._ref.messageType}set type(e){this._ref.messageType=e}get created(){return this._ref.created}set created(e){this._ref.created=e}get isAttachment(){return this._attachment}set isAttachment(e){this._attachment=e}set unique(e){this._ref.messageId=e}get unique(){var e;return null!==(e=this._ref.messageId)&&void 0!==e?e:void 0}get visibility(){return this._ref.visibility}set visibility(e){this._ref.visibility=e}get allowSuggestions(){return!1}get identifier(){return this._ref.messageId}set identifier(e){this._ref.messageId=e}get channelIdentifier(){var e;return null!==(e=this._engagementId)&&void 0!==e?e:""}set channelIdentifier(e){this._engagementId=e}get chatId(){return this._engagementId}set chatId(e){e&&(this._engagementId=e)}set osvcChatId(e){e&&(this._engagementId=e)}get messageDataMap(){return this._messageDataMap}static revive(e){return e}toJSON(){let e;return this.sender&&(e=this.sender.toJSON()),{body:this.body,channelIdentifier:this.channelIdentifier,created:this.created,identifier:this.identifier,isAgentsOnly:this.isAgentsOnly,isAttachment:this.isAttachment,isFailedToSend:!1,messageDataMap:this.messageDataMap,offTheRecord:this._ref.offTheRecord,preserve:this._ref.preserve,richText:this.richText,sender:e,type:this.type,unique:this.unique,visibility:this.visibility}}}var N,O,v;!function(e){e.QUEUED="QUEUED",e.ACTIVE="ACTIVE",e.CONCLUDED="CONCLUDED",e.RELEASED="RELEASED"}(N||(N={})),function(e){e.OFFER_STATUS="OFFER_STATUS",e.OFFER_STATUS_HISTORY="OFFER_STATUS_HISTORY",e.OFFER_CANCELLATION="OFFER_CANCELLATION",e.OFFER_CANCELLATION_HISTORY="OFFER_CANCELLATION_HISTORY",e.CHANNEL_ADDED="CHANNEL_ADDED",e.CHANNEL_REMOVED="CHANNEL_REMOVED",e.CHANNEL_REMOVED_HISTORY="CHANNEL_REMOVED_HISTORY",e.WORK_OFFER="WORK_OFFER",e.WORK_OFFER_HISTORY="WORK_OFFER_HISTORY",e.AVAILABILITY_CHANGE="AVAILABILITY_CHANGE",e.MESSAGE_ADDED="MESSAGE_ADDED",e.MESSAGE_ADDED_HISTORY="MESSAGE_ADDED_HISTORY",e.PRIVATE_MESSAGE_ADDED="PRIVATE_MESSAGE_ADDED",e.MESSAGE_UPDATED="MESSAGE_UPDATED",e.MESSAGE_REMOVED="MESSAGE_REMOVED",e.MESSAGE_FAILED="MESSAGE_FAILED",e.ATTACHMENT_MESSAGE_FAILED="ATTACHMENT_MESSAGE_FAILED",e.ACTIVITY_CHANGE="ACTIVITY_CHANGE",e.MEMBER_JOINED="MEMBER_JOINED",e.MEMBER_JOINED_HISTORY="MEMBER_JOINED_HISTORY",e.MEMBER_LEFT="MEMBER_LEFT",e.MEMBER_LEFT_HISTORY="MEMBER_LEFT_HISTORY",e.MEMBER_UPDATED="MEMBER_UPDATED",e.MEMBER_UPDATED_HISTORY="MEMBER_UPDATED_HISTORY",e.CONTROL_MESSAGE="CONTROL_MESSAGE",e.UPLOAD_STATUS="UPLOAD_STATUS",e.UPLOAD_STATUS_HISTORY="UPLOAD_STATUS_HISTORY",e.UPLOAD_COMPLETED="UPLOAD_COMPLETED",e.UPLOAD_COMPLETED_HISTORY="UPLOAD_COMPLETED_HISTORY",e.CONNECTION_ERROR="CONNECTION_ERROR",e.UNSTABLE_CONNECTION="UNSTABLE_CONNECTION",e.CONNECTION_ESTABLISHED="CONNECTION_ESTABLISHED",e.ROLE_CHANGE="ROLE_CHANGE",e.ROLE_CHANGE_HISTORY="ROLE_CHANGE_HISTORY",e.LEAD_CHANGE="LEAD_CHANGE",e.LEAD_CHANGE_HISTORY="LEAD_CHANGE_HISTORY",e.CONTEXT_UPDATE="CONTEXT_UPDATE",e.CONTEXT_UPDATE_HISTORY="CONTEXT_UPDATE_HISTORY",e.SESSION_CHANGED="SESSION_CHANGED",e.NEW_CHANNEL="NEW_CHANNEL",e.ACTIVITY_STATUS_CHANGE="ACTIVITY_STATUS_CHANGE"}(O||(O={}));class p{constructor(){this.created=new Date}}class C{}!function(e){e.ABSENT="ABSENT",e.ACTIVE="ACTIVE",e.DISCONNECTED="DISCONNECTED",e.UNKNOWN="UNKNOWN"}(v||(v={}));class D{constructor(){this.secondsUntilDisconnect=0}get connectionState(){return this.member.isConnected?v.ACTIVE:v.DISCONNECTED}}const m={},y=e=>{var t;return null!==(t=m[e])&&void 0!==t?t:null};class L{constructor(e){this._engageRef=e,this.destinationType=t.QUEUE,this.enableSessionCheck=!1,this.localeString=navigator.language}get name(){const e=this._engageRef.name;if("string"==typeof e)return e;const t=y(this._engageRef.id);return null!==t?t.name:null}get stripeCode(){var e;const t=y(this._engageRef.id);if(null!==t)return null!==(e=t.stripeCd)&&void 0!==e?e:void 0}get identifier(){return this._engageRef.id}get totalAvailableResources(){return this._engageRef.getAvailableAgents()}get totalUnavilableResources(){return this._engageRef.getUnavailableAgents()}get profileIds(){return this._engageRef.getProfileIds()}get expectedWaitSeconds(){return this._engageRef.getExpectedWaitSeconds()}get availableCapacity(){return this._engageRef.getAvailableCapacity()}}class M{}class U{constructor(){this.created=new Date}}var w,b;!function(e){e.NONE="NONE",e.ACCEPTED="ACCEPTED",e.DECLINED="DECLINED",e.AVAILABLE="AVAILABLE",e.UNAVAILABLE="UNAVAILABLE",e.TIMEOUT="TIMEOUT"}(w||(w={}));class P{}!function(e){e.STARTED="STARTED",e.RECEIVED="RECEIVED"}(b||(b={}));class F{constructor(){this.created=new Date}}var H=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function o(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((i=i.apply(e,t||[])).next())}))};const B="EngageAdapter:Channel:";class G{constructor(e,t){this._visitor=null,this._localJoinFired=!1,this._activeListeners={},this._sessionRef=e,this._session=new R(e,t,!0),this._ref=t,this.initListeners(),this.fireAddLocalParticipant()}fireAddLocalParticipant(){const e=this,t=(n,i,r)=>{var s;if("Active"===n){e._ref.Events.StateChanged.removeListener(t);const a=O.MEMBER_JOINED,o=null!==(s=e._activeListeners[a])&&void 0!==s?s:[];if(o.length>0){e._ref.getIdentifier();const t={created:new Date,channelIdentifier:e._ref.getIdentifier(),participant:e.myParticipant,greeting:"Hello"};setTimeout((()=>{o.forEach((e=>{e(a,t)})),e._localJoinFired=!0,_(a,B,t)}),!0===r?1e3:0)}else setTimeout((()=>{t(n,i,!0)}),1777)}};e._ref.Events.StateChanged.listen(t),"Active"===this._ref.getState()&&setTimeout((()=>{t(this._ref.getState(),this._ref.getState())}),1777)}initListeners(){const t=this,n=t._ref,r=n.Channels.Chat,s=(e,i)=>{var r;const a=!0===(null==i?void 0:i.replay)?O.MESSAGE_ADDED_HISTORY:O.MESSAGE_ADDED,o=null!==(r=t._activeListeners[a])&&void 0!==r?r:[];if(o.length>0){const t=new S(e,n.getIdentifier());o.forEach((e=>e(a,t))),_(a,B,t)}else"Active"===n.getState()&&setTimeout((()=>{s(e,i)}),1e3)};r.Events.MessageAdded.listen(s),r.Events.ParticipantActivityChanged.listen(((i,r)=>{var s;const a=O.ACTIVITY_CHANGE,o=null!==(s=t._activeListeners[a])&&void 0!==s?s:[];if(o.length>0){const t=new c;t.channelIdentifier=n.getIdentifier(),t.fromParticipant=new R(i,n),t.mode="LISTENING"===r?e.LISTENING:e.RESPONDING,o.forEach((e=>{e(a,t)})),_(a,B,t)}})),r.Events.FileAttachmentStateChanged.listen(((e,i)=>{var r;const s=!0===(null==i?void 0:i.replay)?O.UPLOAD_STATUS_HISTORY:O.UPLOAD_STATUS,a=null!==(r=t._activeListeners[s])&&void 0!==r?r:[];if(a.length>0){const t={channelIdentifier:n.getIdentifier(),status:"RECEIVED"===e.status?b.RECEIVED:b.STARTED};a.forEach((e=>e(s,t))),_(s,B,t)}})),r.Events.FileAttachment.listen(((e,i)=>{var r,s,a,o,c;const l=!0===(null==i?void 0:i.replay)?O.UPLOAD_COMPLETED_HISTORY:O.UPLOAD_COMPLETED,E=null!==(r=t._activeListeners[l])&&void 0!==r?r:[];if(E.length>0){const t=new P;t.localReference=e.body.attachment.filename,t.localFileName=e.body.attachment.filename,t.userFileName=e.body.attachment.title,t.contentType=null===(s=e.body)||void 0===s?void 0:s.attachment.contentType,t.fileSize=1024*e.kbFileSize;const i=new F;i.channelIdentifier=n.getIdentifier(),i.status="RECEIVED"===e.status?b.RECEIVED:b.STARTED,i.fileDetails=t,i.created=null!==(c=null!==(o=null===(a=e.body)||void 0===a?void 0:a.timestamp)&&void 0!==o?o:e.created)&&void 0!==c?c:new Date,i.sender=new R(e.sender,n,!1),E.forEach((e=>e(l,i))),_(l,B,i)}})),n.Events.TransferRejected.listen(((e,r,s)=>{var a;const o=!0===(null==s?void 0:s.replay)?O.OFFER_STATUS_HISTORY:O.OFFER_STATUS,c=null!==(a=t._activeListeners[o])&&void 0!==a?a:[],l=new U;l.assignmentType=i.TRANSFER,l.channel=t,l.channelIdentifier=n.getIdentifier(),l.status=w.DECLINED,l.member=new R({getIdentifier:()=>r,isBot:()=>!1,getName:()=>null,getConnectionState:()=>"DISCONNECTED",getGreeting:()=>null,getEmailAddress:()=>null,getRole:()=>"unknown",getContext:()=>null},n,!1),c.length>0&&c.forEach((e=>e(o,l))),_(o,B,l)})),n.Events.TransferAccepted.listen((e=>{var r;const s=!0===(null==e?void 0:e.replay)?O.OFFER_STATUS_HISTORY:O.OFFER_STATUS,a=null!==(r=t._activeListeners[s])&&void 0!==r?r:[];if(t.myParticipant.setTransferCompleted(!0),a.length>0){const e=new U;e.assignmentType=i.TRANSFER,e.channel=t,e.channelIdentifier=n.getIdentifier(),e.status=w.ACCEPTED,a.forEach((t=>t(s,e))),_(s,B,e)}})),n.Events.ConferenceCancelled.listen(((e,r)=>{var s;const a=!0===(null==r?void 0:r.replay)?O.OFFER_STATUS_HISTORY:O.OFFER_STATUS,o=null!==(s=t._activeListeners[a])&&void 0!==s?s:[];if(o.length>0){const e=new U;e.assignmentType=i.CONFERENCE,e.channel=t,e.channelIdentifier=n.getIdentifier(),e.status=w.TIMEOUT,o.forEach((t=>t(a,e))),_(a,B,e)}})),n.Events.ConferenceRejected.listen(((e,r,s)=>{var a;const o=!0===(null==s?void 0:s.replay)?O.OFFER_STATUS_HISTORY:O.OFFER_STATUS,c=null!==(a=t._activeListeners[o])&&void 0!==a?a:[];if(c.length>0){const e=new U;e.assignmentType=i.CONFERENCE,e.channel=t,e.channelIdentifier=n.getIdentifier(),e.status=w.DECLINED,e.member=new R({getIdentifier:()=>r,isBot:()=>!1,getName:()=>null,getConnectionState:()=>"DISCONNECTED",getGreeting:()=>null,getEmailAddress:()=>null,getRole:()=>"unknown",getContext:()=>null},n,!1),c.forEach((t=>t(o,e))),_(o,B,e)}})),n.Events.ConferenceAccepted.listen(((e,r)=>{var s;const a=!0===(null==r?void 0:r.replay)?O.OFFER_STATUS_HISTORY:O.OFFER_STATUS,o=null!==(s=t._activeListeners[a])&&void 0!==s?s:[];if(o.length>0){const e=new U;e.assignmentType=i.CONFERENCE,e.channel=t,e.channelIdentifier=n.getIdentifier(),e.status=w.ACCEPTED,o.forEach((t=>t(a,e))),_(a,B,e)}})),n.Events.OwnerChanged.listen(((e,i,r)=>{var s,a;const o=!0===(null==r?void 0:r.replay),c=o?O.LEAD_CHANGE_HISTORY:O.LEAD_CHANGE,l=null!==(s=t._activeListeners[c])&&void 0!==s?s:[];if("string"!=typeof e&&"string"!=typeof i){if(l.length>0){const t={channelIdentifier:n.getIdentifier(),created:new Date,newLead:"string"==typeof e?e:e.getIdentifier(),oldLead:"string"==typeof i?i:i.getIdentifier()};l.forEach((e=>e(c,t))),_(c,B,t)}const s=o?O.MEMBER_UPDATED_HISTORY:O.MEMBER_UPDATED,E=null!==(a=t._activeListeners[s])&&void 0!==a?a:[];if(E.length>0){const[t]=this.members.filter((e=>e.identifier===i.getIdentifier())),[a]=this.members.filter((t=>t.identifier===e.getIdentifier()));if(void 0!==i){const e=new D;e.member=t,e.created=o?new Date(r.createdTime):new Date,e.channelIdentifier=n.getIdentifier(),E.forEach((t=>t(s,e))),_(c,B,e)}if(void 0!==a){const e=new D;e.member=a,e.created=o?new Date(r.createdTime):new Date,e.channelIdentifier=n.getIdentifier(),E.forEach((t=>t(s,e))),_(c,B,e)}}}}));const a=(e,i,r,s)=>{var o;const c=!0===(null==r?void 0:r.replay);c||!0===s||t.processParticipant(e);const l=c?O.MEMBER_JOINED_HISTORY:O.MEMBER_JOINED,E=null!==(o=t._activeListeners[l])&&void 0!==o?o:[];if(E.length>0){const t=new C;t.created=new Date,t.greeting=null!=i?i:"",t.participant=new R(e,n),t.channelIdentifier=n.getIdentifier(),E.forEach((e=>e(l,t))),_(l,B,t)}else"Active"===n.getState()&&setTimeout((()=>{a(e,i,r,!0)}),1e3)};n.Events.ParticipantConnected.listen(a),n.Events.ParticipantDisconnected.listen(((e,i,r)=>{var s;const a=!0===(null==r?void 0:r.replay)?O.MEMBER_LEFT_HISTORY:O.MEMBER_LEFT,o=null!==(s=t._activeListeners[a])&&void 0!==s?s:[],c=new p;c.created=new Date,c.member=new R(e,n),i&&(c.reason=i),c.channelIdentifier=n.getIdentifier(),o.length>0&&o.forEach((e=>e(a,c))),_(a,B,c)})),n.Events.ParticipantUpdated.listen(((e,i)=>{var r;const s=!0===(null==i?void 0:i.replay),a=s?O.MEMBER_UPDATED_HISTORY:O.MEMBER_UPDATED,o=null!==(r=t._activeListeners[a])&&void 0!==r?r:[];if(o.length>0){const t=new D;t.member=new R(e,n),t.created=s?new Date(i.createdTime):new Date,t.channelIdentifier=n.getIdentifier(),o.forEach((e=>e(a,t))),_(a,B,t)}})),n.Events.EngagementEnded.listen(((e,i)=>{var r;const s=!0===(null==i?void 0:i.replay)?O.CHANNEL_REMOVED_HISTORY:O.CHANNEL_REMOVED,a=null!==(r=t._activeListeners[s])&&void 0!==r?r:[];if(a.length>0){const e=new d;e.channelIdentifier=n.getIdentifier(),a.forEach((t=>t(s,e))),_(s,B,e)}})),n.Events.EngagementDisconnected.listen(((e,i)=>{var r;const s=!0===(null==i?void 0:i.replay)?O.MEMBER_LEFT_HISTORY:O.MEMBER_LEFT,a=null!==(r=t._activeListeners[s])&&void 0!==r?r:[];if(a.length>0){const i=new p;i.created=new Date,i.member=new R(t._sessionRef,n,!0),e&&(i.reason=e),i.channelIdentifier=n.getIdentifier(),a.forEach((e=>e(s,i))),_(s,B,i)}}))}processParticipant(e){const t=this;e.Events.RoleChanged.listen(((e,n,i,r)=>{var s;const a=!0===(null==r?void 0:r.replay)?O.ROLE_CHANGE_HISTORY:O.ROLE_CHANGE,o=null!==(s=t._activeListeners[a])&&void 0!==s?s:[];if(o.length>0){const t=new M;t.channelIdentifier=i,t.role="agent"===e?A.LEAD:A.CONFEREE,o.forEach((e=>{e(a,t)})),_(a,B,t)}}))}conclude(){return this._ref.disconnect()}leave(){return this._ref.leave()}close(){return this._ref.disconnect()}get identifier(){return this._ref.getIdentifier()}get state(){var e;switch(null===(e=this._ref.Channels.Chat)||void 0===e?void 0:e.getState()){case"ChannelActive":return N.ACTIVE;case"ChannelIdle":return N.RELEASED;case"ChannelInit":if("Active"===this._ref.getState())return N.ACTIVE}}get members(){const e=[];return this._ref.getRemoteParticipants().forEach((t=>{e.push(new R(t,this._ref))})),this._localJoinFired&&e.push(this.myParticipant),e}get context(){const e=this.getVisitor().getContext(),t=new Map;return Object.keys(e).forEach((n=>{t.set(n,e[n])})),t}get myParticipant(){return this._session}get workTypeCode(){}sendAttachment(e){const t=this,n=t._ref,i=n.Channels.Chat,r=e.map((e=>i.sendAttachmentNotification({contentType:e.contentType,fileSize:e.fileSize,localFileName:e.localFileName,userFileName:e.userFileName,statusCode:"RECEIVED"})));return new Promise(((i,s)=>{Promise.all(r).then((()=>{i()})).catch((i=>{var r;const a=O.ATTACHMENT_MESSAGE_FAILED,o=null!==(r=t._activeListeners[a])&&void 0!==r?r:[];if(o.length>0){const t={channelIdentifier:n.getIdentifier(),fileAttachmentDetail:e};o.forEach((e=>{e(a,t)})),_(a,B,t)}h(B,`Attachment Message could not be sent due to '${i}'`),s(i)}))}))}transfer(e){return H(this,void 0,void 0,(function*(){const n=this._ref,i={destinationType:e.destinationType===t.QUEUE?"QUEUE":"AGENT",id:e.identifier,name:e.name};try{return yield n.transfer(i),e.destinationType===t.QUEUE?r.COMPLETE:r.PROCESSING}catch(e){return Promise.reject(e)}}))}conference(e){return H(this,void 0,void 0,(function*(){const n=this._ref;if(e.destinationType===t.QUEUE){const e="Conferencing with a queue is not supported";return h(B,e),Promise.reject(new Error(e))}const i={destinationType:"AGENT",id:e.identifier,name:e.name};try{return yield n.conference(i),r.PROCESSING}catch(e){return Promise.reject(e)}}))}cancelInvitation(e,t){return H(this,void 0,void 0,(function*(){const n=this._ref.getIdentifier(),r=this._sessionRef.getPendingOffers(),s=e===i.CONFERENCE?"CONFERENCE":e===i.TRANSFER?"TRANSFER":void 0;if(void 0===s){const t=`Unknown assignment type: ${e}`;return h(B,t),Promise.reject(new RangeError(t))}let a;for(let e=0;e<r.length;e++){const t=r[e];if(t.getOfferType()===s&&t.getIdentifier()===n){a=t;break}}if(void 0===a){const t=`Failed to find engage offer with id=${n} and type=${e}`;return h(B,t),Promise.reject(new Error(t))}try{yield this._sessionRef.cancelInvitation(a,{id:t,destinationType:"AGENT",name:""})}catch(e){return Promise.reject(e)}}))}refreshMessages(){return this._sessionRef.restartPolling()}assignRole(e,t){if(e!==A.LEAD){const e="Only reassignment of LEAD is supported at the moment";throw h(B,e),new RangeError(e)}const n=this._ref.getRemoteParticipant(t.identifier);if(null===n){const e="Unknown participant "+t.identifier;throw h(B,e),new Error(e)}return this._ref.assignOwner(n)}setInteractionState(t){const n=this._ref.Channels.Chat;let i;switch(t){case e.LISTENING:i="LISTENING";break;case e.AGENTS_ONLY_RESPONDING:case e.RESPONDING:i="RESPONDING"}return i?new Promise(((r,s)=>{n.postActivity(i,t===e.AGENTS_ONLY_RESPONDING).then((()=>r("SUCCESS"))).catch((()=>r("FAILURE")))})):Promise.resolve("FAILURE")}sendMessage(e,t,n,i){const r=this._ref.Channels.Chat,s={};return(null==i?void 0:i.size)>0&&i.forEach(((e,t)=>{s[t]=e})),r.sendMessage({body:e,messageId:t,messageDataMap:s,visibility:n,richText:!0,messageType:"RICH_TEXT",sender:this._sessionRef,preserve:!0,offTheRecord:!1})}get contactInfo(){return I(this.getVisitor().getContext())}on(e,t){const n=this;switch(e){case O.ACTIVITY_CHANGE:case O.MESSAGE_ADDED:case O.MESSAGE_ADDED_HISTORY:case O.ROLE_CHANGE:case O.ROLE_CHANGE_HISTORY:case O.OFFER_STATUS:case O.OFFER_STATUS_HISTORY:case O.LEAD_CHANGE:case O.LEAD_CHANGE_HISTORY:case O.MEMBER_JOINED:case O.MEMBER_JOINED_HISTORY:case O.MEMBER_LEFT:case O.MEMBER_LEFT_HISTORY:case O.MEMBER_UPDATED:case O.MEMBER_UPDATED_HISTORY:case O.CHANNEL_REMOVED:case O.CHANNEL_REMOVED_HISTORY:case O.ATTACHMENT_MESSAGE_FAILED:case O.UPLOAD_STATUS:case O.UPLOAD_STATUS_HISTORY:case O.UPLOAD_COMPLETED:case O.UPLOAD_COMPLETED_HISTORY:n._activeListeners[e]||(n._activeListeners[e]=[]),-1===n._activeListeners[e].indexOf(t)&&(g(B,"Added listener for "+e),n._activeListeners[e].push(t));break;default:h(B,"Event "+e+" is not currently supported")}}modifyProperties(e){return H(this,void 0,void 0,(function*(){this.getVisitor().reference(),yield this._ref.modifyProperties(e)}))}listTransferDestinations(){return H(this,void 0,void 0,(function*(){const e=yield this._ref.listTransferDestinations(),t=[];return e.forEach((e=>{if("QUEUE"===e.destinationType){const n=new L(e);t.push(n)}else{const n=new l(e);t.push(n)}})),t}))}getVisitor(){if(null===this._visitor){const[e]=this.members.filter((e=>"visitor"===e.getRole()));this._visitor=e}return this._visitor}}class Y{}var x,V,k,j,$,W,J;!function(e){e.FIRST_NAME="firstName",e.LAST_NAME="lastName",e.CONTACT_ID="contactId",e.INCIDENT_ID="incidentId",e.QUESTION="question",e.EMAIL="emailAddress",e.PRODUCT_ID="productId",e.QUEUE_NAME="QUEUE_NAME",e.OFFER_TIMEOUT="offerTimeOut"}(x||(x={}));class K{}!function(e){e.IDLE_TIMEOUT="IDLE_TIMEOUT",e.NONE="NONE",e.AGENT_CONCLUDED="AGENT_CONCLUDED",e.NO_AGENTS_AVAILABLE="NO_AGENTS_AVAILABLE",e.TRANSFERRED_TO_QUEUE="TRANSFERRED_TO_QUEUE",e.PARTICIPANT_LEFT="PARTICIPANT_LEFT",e.END_USER_CONCLUDED="END_USER_CONCLUDED"}(V||(V={})),function(e){e.ANOTHER_LOGIN="ANOTHER LOGIN",e.CONFLICTING_SESSION="CONFLICTING_SESSION",e.CONNECTION_ERROR="CONNECTION_ERROR",e.UNKNOWN_ERROR="UNKOWN_ERROR",e.INCOMPATIBLE_BROWSER="INCOMPATIBLE_BROWSER"}(k||(k={})),function(e){e.ACCEPTED="ACCEPTED",e.MODIFIED="MODIFIED",e.DISMISSED="DISMISSED"}(j||(j={})),function(e){e.SUGGESTION="SUGGESTION",e.SUMMARY="SUMMARY"}($||($={}));class Q extends T{constructor(){super(),this._firstName="",this._lastName="",this._emailAddress="",this._type=s.HUMAN}setFirstName(e){const t=this;Q.onSetterInvoked("firstName",t.firstName,e),t._firstName=e,t.setName()}get firstName(){return this._firstName}set firstName(e){this.setFirstName(e)}setLastName(e){const t=this;Q.onSetterInvoked("lastName",t.lastName,e),t._lastName=e,t.setName()}get lastName(){return this._lastName}set lastName(e){this.setLastName(e)}setName(){this._name=`${this.firstName} ${this.lastName}`}get emailAddress(){return this._emailAddress}set emailAddress(e){Q.onSetterInvoked("emailAddress",this._emailAddress,e),this._emailAddress=e}getEmailAddress(){return this._emailAddress}get contactInfo(){return this._contactInfo}set contactInfo(e){Q.onSetterInvoked("contactInfo",this._contactInfo,e),this._contactInfo=e}getContext(){return this._contactInfo}}class q{constructor(){this.created=new Date}}!function(e){e.INCOMPATIBLE_BROWSER="INCOMPATIBLE_BROWSER",e.COMMUNICATION_ERROR="COMMUNICATION_ERROR",e.COMMUNICATION_LOST="COMMUNICATION_LOST",e.SEVERE_ERROR="SEVERE_ERROR",e.CLIENT_ERROR="CLIENT_ERROR",e.RESOURCE_UNAVAILABLE="RESOURCE_UNAVAILABLE"}(W||(W={})),function(e){e.MANUAL="MANUAL",e.AUTO="AUTO",e.FORCED="FORCED"}(J||(J={}));var z,X,Z=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function o(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((i=i.apply(e,t||[])).next())}))};class ee{static initMercuryOffer(e){const t=new ee(e),n=e;t._created=new Date;const i=t._created.getTime();return Object.defineProperties(t,{context:{get:function(){null===t._initiator&&(t._initiator=new R(t._ref.getInitiator(),null));const e=t._initiator.getContext(),n="fusionEngagementId";e[n]||(e[n]=`${t.identifier}_${i}`);const r=new Map;return Object.keys(e).forEach((t=>{let n=e[t];"number"==typeof n&&(n=n.toString()),r.set(t,n)})),r},set:function(e){throw new Error("Modifying offer context is not allowed")},enumerable:!0},_ref:{get:function(){return n},enumerable:!1}}),t}constructor(...e){this._initiator=null;const[t]=e;if(!t||"object"!=typeof t||"function"!=typeof t.getIdentifier)throw new Error("MercuryOffer should not be initialized via a public constructor")}get created(){return this._created}get conversationId(){}get identifier(){return this._ref.getIdentifier()}get type(){return this._ref.getLeadingChannel().toUpperCase()}get workTypeCode(){}get behavior(){return this._ref.getBehavior()}set behavior(e){throw new Error("Modifying low-level properties is not allowed")}get timeout(){return this._ref.getOfferTimeout()}set timeout(e){throw new Error("Modifying low-level properties is not allowed")}get externalIdString(){return this._ref.getExternalWorkId()}get fusionChannelId(){return this._ref.getExternalChannelId()}get assignmentType(){switch(this._ref.getOfferType()){case"TRANSFER":return i.TRANSFER;case"CONFERENCE":return i.CONFERENCE;default:return i.LEAD}}set assignmentType(e){throw new Error("Modifying low-level properties is not allowed")}get from(){return null===this._initiator&&(this._initiator=new R(this._ref.getInitiator(),null)),this._initiator}set from(e){throw new Error("Modifying low-level properties is not allowed")}rejectOffer(e){return Z(this,arguments,void 0,(function*(e,t=J.MANUAL){return yield e.rejectEngagement(this._ref,t)}))}acceptOffer(e){return Z(this,arguments,void 0,(function*(e,t=J.MANUAL){return yield e.acceptEngagement(this._ref,t)}))}}class te{}!function(e){e.TEXT="RICH_TEXT",e.RICHTEXT="RICH_TEXT",e.STRUCTURED="STRUCTURED"}(z||(z={})),function(e){e.Manual="Manual",e.TimedAutoAccept="TimedAutoAccept",e.TimedAutoReject="TimedAutoReject",e.ForcedAccept="ForcedAccept"}(X||(X={}));class ne{constructor(e){this.contextReady=()=>{let e=!1;return new Promise((t=>{const n=()=>{e||"complete"!==document.readyState||(e=!0,document.removeEventListener("readystatechange",n),t())},i=()=>{if(self.document){if("complete"===document.readyState)return e=!0,void t();document.addEventListener("readystatechange",n)}};if(self.document)i();else{const e=setInterval((()=>{self.document&&(clearInterval(e),i())}),111)}}))},this.loadEngageSdk=()=>{return e=this,t=void 0,i=function*(){if(ne._loadStarted=!0,console.log("Engage:: came to loadEngageSdk"),ne._engageRef)return console.log("Engage:: SDK already loaded"),Promise.resolve(ne._engageRef);yield this.contextReady();const e=document.createElement("script");return new Promise(((t,n)=>{e.src=this._engageUri,e.onload=()=>{console.log("Engage:: engage SDK loaded"),ne._engageRef=null===Oracle||void 0===Oracle?void 0:Oracle.Engage,this.fireReady(),t(ne._engageRef)},e.onerror=()=>{console.error("Engage:: failed to load the SDK from "+this._engageUri),this.fireError(new Error("SDK_LOAD_FAILED")),n()},document.head.appendChild(e)}))},new((n=void 0)||(n=Promise))((function(r,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function o(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((i=i.apply(e,t||[])).next())}));var e,t,n,i},this._engageUri=e,"undefined"==typeof Oracle||void 0===Oracle.Engage?this.loadEngageSdk():this.fireReady()}fireReady(){null!==ne._readyResolve&&(console.log("Engage:: resolving ready promise"),ne._readyResolve(),ne._readyResolve=null,ne._readyReject=null)}fireError(e){null!==ne._readyReject&&(console.log("Engage:: rejecting the ready promise"),ne._readyReject(e),ne._readyResolve=null,ne._readyReject=null)}static getEngageInstance(){return ne._engageRef}static ready(e){if(!e)throw new Error("configuration required");if(!e.sdkLocation)throw new Error("SDK location is not configured");let t;if("string"==typeof e.sdkLocation.overrideUri&&""!==e.sdkLocation.overrideUri)t=e.sdkLocation.overrideUri;else{let n=e.sdkLocation.cdnHost,i=e.sdkLocation.cdnPath;if("string"!=typeof n||""===n)throw new Error("SDK CDN host must be configured");if("string"!=typeof i||""===i)throw new Error("SDK CDN path must be configured");if(n.endsWith("/")&&(n=n.substring(0,n.length-1)),i.startsWith("/")||(i="/"+i),t=n+i,"string"==typeof e.sdkLocation.versionToken&&""!==e.sdkLocation.versionToken){const n=e.sdkLocation.versionToken;t=t.replace(/\{channel\}/g,n)}else if("string"==typeof e.sdkLocation.distributionChannel&&e.sdkLocation.distributionChannel){const n=e.sdkLocation.distributionChannel.toLowerCase();t=t.replace(/\{channel\}/g,n)}"string"==typeof e.sdkLocation.tenancyRegion&&""!==e.sdkLocation.tenancyRegion&&(t=t.replace(/\{region\}/g,e.sdkLocation.tenancyRegion))}return-1===t.indexOf("://")&&(t="https://"+t),ne._loadStarted||new ne(t),ne._readyPromise}}ne._readyResolve=null,ne._readyReject=null,ne._readyPromise=new Promise(((e,t)=>{ne._readyResolve=e,ne._readyReject=t})),ne._loadStarted=!1,ne._engageRef=null;var ie,re=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function o(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((i=i.apply(e,t||[])).next())}))};!function(e){e[e.GET=0]="GET",e[e.PUT=1]="PUT",e[e.DELETE=2]="DELETE",e[e.DELETE_BY_FILTER=3]="DELETE_BY_FILTER",e[e.CLEANUP=4]="CLEANUP",e[e.GET_ALL=5]="GET_ALL",e[e.CLEAR=6]="CLEAR"}(ie||(ie={}));class se{constructor(){this.init()}static getInstance(){return se.instance||(se.instance=new se),se.instance}static doOperation(e,t){return re(this,void 0,void 0,(function*(){try{const n=0===t.operation?"readonly":"readwrite";if(4===t.operation){if(!t.objectStorage)return se.cleanUpStaleData(e);{const n=se.getSchemaDetails(t.objectStorage);if(n)return se.cleanUpStaleDataFromObjectStore(e,n)}}const i=e.transaction(t.objectStorage,n).objectStore(t.objectStorage);let r;switch(t.operation){case 0:r=i.get(t.data);break;case 1:r=i.put(t.data);break;case 2:r=i.delete(t.data);break;case 5:r=i.getAll();break;case 6:r=i.clear();break;case 3:return se.deleteItemsByFilter(i,t.filterFunction)}return new Promise(((e,t)=>{r.onsuccess=t=>{e(t.target.result)},r.onerror=e=>{t(e)}}))}catch(e){return console.warn(`${se.PRE} Error adding record in Local DB ${t.objectStorage}`),console.warn(e),Promise.reject(e)}}))}static cleanUpStaleData(e){return re(this,void 0,void 0,(function*(){se.IDB_DATABASE_SCHEMA.forEach((t=>re(this,void 0,void 0,(function*(){yield this.cleanUpStaleDataFromObjectStore(e,t)}))))}))}static cleanUpStaleDataFromObjectStore(e,t){return re(this,void 0,void 0,(function*(){if(t.cleanupFunction)try{const n=e.transaction(t.name,"readwrite").objectStore(t.name);se.deleteItemsByFilter(n,t.cleanupFunction)}catch(e){console.warn(`${se.PRE} Error while stale data cleanup for ${t.name}`)}}))}static deleteItemsByFilter(e,t){return re(this,void 0,void 0,(function*(){return t?new Promise(((n,i)=>{e.openCursor().onsuccess=e=>{var i;const r=null===(i=e.target)||void 0===i?void 0:i.result;r?(t(r)&&r.delete(),r.continue()):n(!0)},e.openCursor().onerror=e=>{i(e)}})):(console.warn(`${this.PRE} missing filter function`),!1)}))}static upgradeNeeded(e){return re(this,void 0,void 0,(function*(){console.warn(`${se.PRE} DB Upgrade Started`);try{const t=e.target.result;return se.IDB_DATABASE_SCHEMA.forEach((e=>{if(!t.objectStoreNames.contains(e.name)){const n=t.createObjectStore(e.name,{keyPath:e.key});e.indexes&&e.indexes.length>0&&e.indexes.forEach((e=>{n.createIndex(e.name,e.name,{unique:e.unique})}))}})),console.warn(`${se.PRE} DB Upgrade Success for`),Promise.resolve(t)}catch(e){return console.warn(`${se.PRE} Error while upgrading DB`),console.warn(e),Promise.reject(e)}}))}static getSchemaDetails(e){return se.IDB_DATABASE_SCHEMA.get(e)}performIndexDbOperation(e){return re(this,void 0,void 0,(function*(){const t=self.indexedDB.open(se.DB_NAME,se.DB_VERSION);return new Promise(((n,i)=>{t.onsuccess=t=>re(this,void 0,void 0,(function*(){var r;try{const i=null===(r=t.target)||void 0===r?void 0:r.result,s=yield se.doOperation(i,e);n(s)}catch(e){i(e)}})),t.onupgradeneeded=e=>re(this,void 0,void 0,(function*(){try{yield se.upgradeNeeded(e)}catch(e){i(e)}})),t.onerror=e=>{i(e)},t.onblocked=e=>{i(e)}}))}))}init(){this.performIndexDbOperation({data:"",objectStorage:"",operation:4})}}se.PRE="[IndexedDbManager] ",se.DB_NAME="engage-web-sdk",se.DB_VERSION=3,se.IDB_DATABASE_SCHEMA=new Map([["logger",{cleanupFunction:e=>{var t;return Date.now()-(null===(t=e.value)||void 0===t?void 0:t.created)>18e5},key:"created",name:"logger"}]]);class ae{constructor(e){this.debugEnabled=!1,"boolean"==typeof e&&(this.debugEnabled=e)}log(e,t){const n=e&&"string"==typeof e?e:ae.appName;this.storeLogsToIndexedDb(n.endsWith(":")?n.substring(0,n.length-1):n,t,"LOG")}info(e,t){const n=e&&"string"==typeof e?e:ae.appName;this.storeLogsToIndexedDb(n.endsWith(":")?n.substring(0,n.length-1):n,t,"DEBUG")}warn(e,t){const n=e&&"string"==typeof e?e:ae.appName;this.storeLogsToIndexedDb(n.endsWith(":")?n.substring(0,n.length-1):n,t,"WARN")}setDebugMode(e){"boolean"==typeof e&&(this.debugEnabled=e)}event(e,t,...n){const i=`Fired ${e} with ${JSON.stringify(n)}`,r="string"==typeof t&&t.endsWith(":")?t.substring(0,t.length-1):t;this.storeLogsToIndexedDb(r,i,"EVENT")}error(e,t){const n=e&&"string"==typeof e?e:ae.appName;this.storeLogsToIndexedDb(n.endsWith(":")?n.substring(0,n.length-1):n,t,"ERROR")}static getIndexedDbManager(){return ae.indexedDbManager||(ae.indexedDbManager=se.getInstance()),ae.indexedDbManager}storeLogsToIndexedDb(e,t,n,...i){if(!this.debugEnabled&&"ERROR"!==n&&"WARN"!==n&&"EVENT"!==n)return;let r="",s=t;try{r=JSON.stringify(i),"string"==typeof t||t instanceof String||(s=JSON.stringify(t))}catch(e){r=""}const a={data:{scope:e,created:Date.now(),jsonString:r,level:n,message:s,windowName:ae.appName},objectStorage:"logger",operation:1};try{ae.getIndexedDbManager().performIndexDbOperation(a)}catch(e){r=""}}}ae.appName="Engage-SDK";const oe=(e,t=2)=>{let n=e.toString();for(;n.length<t;)n="0"+n;return n},ce=()=>{const e=new Date,t=oe(e.getHours()),n=oe(e.getMinutes()),i=oe(e.getSeconds()),r=oe(e.getMilliseconds(),3),s=oe(e.getDate());return`${oe(e.getMonth()+1)}/${s}/${e.getFullYear()} ${t}:${n}:${i}.${r}`};class le{constructor(e){this.debugEnabled=!1,"boolean"==typeof e&&(this.debugEnabled=e)}setDebugMode(e){"boolean"==typeof e&&(this.debugEnabled=e)}log(e,t){if(!this.debugEnabled)return;const n=ce();console.log(`[${n}] ${e}`,t)}warn(e,t){const n=ce();console.warn(`[${n}] ${e}`,t)}error(e,t){const n=ce();console.error(`[${n}] ${e}`,t)}info(e,t){if(!this.debugEnabled)return;const n=ce();console.info(`[${n}] ${e}`,t)}event(e,t,...n){const i=ce();console.log(`[${i}] ${t}`,`Firing ${e} with ${JSON.stringify(n)}`)}}var Ee=function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{c(i.next(e))}catch(e){s(e)}}function o(e){try{c(i.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}c((i=i.apply(e,t||[])).next())}))};const de="EngageAdapter:Session:";class fe{constructor(e){this._activeListeners={},this._session=e}timeoutOffer(e){return Ee(this,void 0,void 0,(function*(){if(!e)throw new Error("Offer must contain a value");return e.rejectOffer(this._session,J.AUTO)}))}rejectOffer(e){return Ee(this,void 0,void 0,(function*(){if(!e)throw new Error("Offer must contain a value");return e.rejectOffer(this._session,J.MANUAL)}))}acceptOffer(e){return Ee(this,arguments,void 0,(function*(e,t=J.MANUAL){if(!e)throw new Error("Offer must contain a value");const n=yield e.acceptOffer(this._session,t),i=n.getIdentifier();return fe._channels[i]||(fe._channels[i]=new G(this._session,n)),fe._channels[i]}))}setActivityStatus(e){return Ee(this,void 0,void 0,(function*(){return 21===e?yield this._session.setAvailability("Available"):0===e?yield this._session.setAvailability("MercuryContextUnload"):yield this._session.setAvailability("Unavailable")}))}getEngageSession(){return this._session}getChannels(){const e=[];return this._session.getActiveEngagements().forEach((t=>{const n=t.getIdentifier();fe._channels[n]||(fe._channels[n]=new G(this._session,t)),e.push(fe._channels[n])})),e}end(e){return this._session.disconnect(e?"PARTICIPANT_LEFT":void 0)}get clientIdentifier(){return this._session.getIdentifier()}get availability(){const e=this._session.getAvailability(),t=new Map;return Object.keys(e).forEach((n=>{const i=e[n];t.set(n.toUpperCase(),i)})),t}requestAssignment(){return Ee(this,void 0,void 0,(function*(){return yield this._session.requestAssignment()}))}startListening(){this._session.restartPolling()}static create(e,t,n){return Ee(this,void 0,void 0,(function*(){if(!0!==n){const e="Non-OSVC flow not supported by this adapter";return h(de,e),Promise.reject(new Error(e))}let i=t.endPoint;if("string"!=typeof i){const e="Invalid endpoint: a string is expected";return h(de,e),Promise.reject(new Error(e))}if(-1===i.indexOf("/engagement/api/agent/")){const e="Invalid endpoint: unexpected URI format";return h(de,e),Promise.reject(new Error(e))}i.endsWith("/")&&(i=i.substring(0,i.length-1));const r=Object.assign({consoleSessionId:"0",profileId:"1"},t);t.delayGetMessages&&(r.delayPolling="true");const[s,a]=i.split("/engagement/api/agent/");let o;if("string"!=typeof a){const e="Invalid endpoint: failed to retrieve siteName";return h(de,e),Promise.reject(new Error(e))}[o]=a.split("/"),r.URI=s;const c="Y"===t.debugEnabled,l={channels:{Chat:{preferred:!0,delayPolling:!0,maxSessions:t.maxSessions,maxActiveSessions:t.maxActiveSessions,apiType:"B2C",attachmentSettings:{maxFileSizeMb:2}}},loggers:[new ae(c)],overrides:{OSVC:{api:["availability","createSession"]}}};var E;c&&(void 0===l.loggers&&(l.loggers=[]),l.loggers.push(new le(c))),(E=l.loggers)&&E.length>0&&E.forEach((e=>{-1===f.indexOf(e)&&f.push(e)})),yield ne.ready(t);const d=ne.getEngageInstance();if(!d){const e="Failed to obtain SDK instance";return h(de,e),Promise.reject(new Error(e))}const u=d.getState();if("INIT"!==u&&"IDLE"!==u){const e=`Unexpected Engage state: ${u}`;return h(de,e),Promise.reject(new Error(e))}d.config(l),t.queues&&t.queues.length>0&&t.queues.forEach((e=>{var t;m[(t=e).id]=t})),yield d.ready();const g=yield d.createParticipant("agent",(()=>new Promise(((n,i)=>Ee(this,void 0,void 0,(function*(){var i;r.URI=s,r.logonOverride="true",r.tenantName=o,r.jwt=e,void 0!==t.accountId?r.accountId=t.accountId:void 0!==t.chatServerAccountId&&(r.accountId=t.chatServerAccountId),void 0!==t.chatServerConsoleSessionId&&(r.consoleSessionId=t.chatServerConsoleSessionId),void 0!==t.chatServerProfileId&&(r.profileId=t.chatServerProfileId);const a={trustToken:e,endpoint:s,tenantName:o};if("string"!=typeof a.pool){let e=null!==(i=t.pool)&&void 0!==i?i:t.chatServerPool;"string"==typeof e&&e.startsWith("?pool=")&&(e=e.substring(6)),a.pool=e}n(a)}))))),r);window.agent=g;const T=new fe(g);return g.Events.NewOffer.listen(((e,t)=>{var n;const i=!0===(null==t?void 0:t.replay)?O.WORK_OFFER_HISTORY:O.WORK_OFFER,r=null!==(n=T._activeListeners[i])&&void 0!==n?n:[];if(r.length>0){const t=ee.initMercuryOffer(e);r.forEach((e=>e(i,t))),_(i,de,t)}})),g.Events.AvailabilityChanged.listen(((e,t,n)=>{var i;const r=O.AVAILABILITY_CHANGE,s=null!==(i=T._activeListeners[r])&&void 0!==i?i:[];if(s.length>0){const e=T.availability;s.forEach((e=>{})),_(r,de,Object.fromEntries(e))}})),g.Events.EngagementEnded.listen(((e,t)=>{var n;const i=!0===(null==t?void 0:t.replay)?O.CHANNEL_REMOVED_HISTORY:O.CHANNEL_REMOVED,r=null!==(n=T._activeListeners[i])&&void 0!==n?n:[];if(r.length>0){const t=e.getIdentifier();fe._channels[t]||(fe._channels[t]=new G(g,e));const n=fe._channels[t];r.forEach((e=>{e(i,n)})),_(i,de,n)}})),g.Events.OfferCancelled.listen(((e,t)=>{var n;const i=!0===(null==t?void 0:t.replay)?O.OFFER_CANCELLATION_HISTORY:O.OFFER_CANCELLATION,r=null!==(n=T._activeListeners[i])&&void 0!==n?n:[];if(r.length>0){const t={channelIdentifier:e.getIdentifier(),type:"ASSIGNMENT_INVITATION_CANCELLED"};r.forEach((e=>{e(i,t)})),_(i,de,t)}})),g.Events.ConnectionError.listen((e=>{var t;if(e){const n=O.CONNECTION_ERROR,i=null!==(t=T._activeListeners[n])&&void 0!==t?t:[];if(i.length>0){const t=e.statusCode;let r="CONNECTION_ERROR";403!==t&&404!==t||(r="ANOTHER LOGIN"),e.reason=r,i.forEach((t=>{t(n,{error:e,reason:r})})),_(n,de,e)}}})),g.Events.StateChanged.listen(((e,t,n)=>{var i,r;if("Connected"===e&&"UnstableConnection"===t){const e=O.CONNECTION_ESTABLISHED,t=null!==(i=T._activeListeners[e])&&void 0!==i?i:[];if(t.length>0){const i={message:n};t.forEach((t=>{t(e,i)})),_(e,de,i)}}else if("UnstableConnection"===e){const e=O.UNSTABLE_CONNECTION,t=null!==(r=T._activeListeners[e])&&void 0!==r?r:[];t.length>0&&(t.forEach((t=>{t(e,{})})),_(e,de))}})),g.Events.EngagementAccepted.listen(((e,t)=>{var n;if(!0!==(null==t?void 0:t.replay)){const t=O.CHANNEL_ADDED,i=null!==(n=T._activeListeners[t])&&void 0!==n?n:[];if(i.length>0){const n=e.getIdentifier();fe._channels[n]||(fe._channels[n]=new G(g,e));const r=fe._channels[n];i.forEach((e=>{e(t,r)})),_(t,de,r)}}e.Events.ParticipantConnected.listen(((t,n,i)=>{var r;const s=!0===(null==i?void 0:i.replay)?O.MEMBER_JOINED_HISTORY:O.MEMBER_JOINED,a=null!==(r=T._activeListeners[s])&&void 0!==r?r:[];if(a.length>0){const i={channelIdentifier:e.getIdentifier(),participant:new R(t,e),greeting:null!=n?n:"",created:new Date};a.forEach((e=>{e(s,i)})),_(s,de,i)}})),e.Events.ParticipantDisconnected.listen(((t,n,i)=>{var r;const s=!0===(null==i?void 0:i.replay)?O.MEMBER_LEFT_HISTORY:O.MEMBER_LEFT,a=null!==(r=T._activeListeners[s])&&void 0!==r?r:[],o={channelIdentifier:e.getIdentifier(),participant:new R(t,e),reason:n};a.length>0&&a.forEach((e=>{e(s,o)})),_(s,de,o)})),e.Events.ParticipantUpdated.listen(((t,n)=>{var i;const r=!0===(null==n?void 0:n.replay)?O.MEMBER_UPDATED_HISTORY:O.MEMBER_UPDATED,s=null!==(i=T._activeListeners[r])&&void 0!==i?i:[];if(s.length>0){const n={channelIdentifier:e.getIdentifier(),participant:new R(t,e)};s.forEach((e=>{e(r,n)})),_(r,de,n)}}));const i=e.Channels.Chat;i.Events.FileAttachmentStateChanged.listen(((t,n)=>{var i;const r=!0===(null==n?void 0:n.replay)?O.UPLOAD_STATUS_HISTORY:O.UPLOAD_STATUS,s=null!==(i=T._activeListeners[r])&&void 0!==i?i:[];if(s.length>0){const n={channelIdentifier:e.getIdentifier(),status:"RECEIVED"===t.status?b.RECEIVED:b.STARTED};s.forEach((e=>{e(r,n)})),_(r,de,n)}})),i.Events.FileAttachment.listen(((t,n)=>{var i,r,s,a,o;const c=!0===(null==n?void 0:n.replay)?O.UPLOAD_COMPLETED_HISTORY:O.UPLOAD_COMPLETED,l=null!==(i=T._activeListeners[c])&&void 0!==i?i:[];if(l.length>0){const n=new P;n.localReference=t.body.attachment.filename,n.localFileName=t.body.attachment.filename,n.userFileName=t.body.attachment.title,n.contentType=null===(r=t.body)||void 0===r?void 0:r.attachment.contentType,n.fileSize=1024*t.kbFileSize;const i=new F;i.channelIdentifier=e.getIdentifier(),i.status="RECEIVED"===t.status?b.RECEIVED:b.STARTED,i.fileDetails=n,i.created=null!==(o=null!==(a=null===(s=t.body)||void 0===s?void 0:s.timestamp)&&void 0!==a?a:t.created)&&void 0!==o?o:new Date,i.sender=new R(t.sender,e,!1),l.forEach((e=>e(c,i))),_(c,de,i)}}))})),T}))}on(e,t){switch(e){case O.WORK_OFFER:case O.WORK_OFFER_HISTORY:case O.CHANNEL_ADDED:case O.CHANNEL_REMOVED:case O.CHANNEL_REMOVED_HISTORY:case O.MEMBER_JOINED:case O.MEMBER_JOINED_HISTORY:case O.MEMBER_LEFT:case O.MEMBER_LEFT_HISTORY:case O.MEMBER_UPDATED:case O.MEMBER_UPDATED_HISTORY:case O.OFFER_CANCELLATION:case O.OFFER_CANCELLATION_HISTORY:case O.UPLOAD_STATUS:case O.UPLOAD_STATUS_HISTORY:case O.UPLOAD_COMPLETED:case O.UPLOAD_COMPLETED_HISTORY:case O.CONNECTION_ERROR:case O.CONNECTION_ESTABLISHED:case O.UNSTABLE_CONNECTION:case O.AVAILABILITY_CHANGE:g(de,`Adding Session listener for ${e}`),this._activeListeners[e]||(this._activeListeners[e]=[]),-1===this._activeListeners[e].indexOf(t)&&this._activeListeners[e].push(t);break;case O.CONTROL_MESSAGE:case O.ACTIVITY_CHANGE:break;default:h(de,`Event ${e} is not currently supported`)}}}return fe._channels={},o})()));